<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="reset-card.css">
    <link rel="stylesheet" href="shared-optimizations.css?v=1.0">
    <title>Smart Locker - Reset Kartu</title>
</head>

<body>
    <!-- Animated Background -->
    <div class="particles-bg">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <button class="back-btn" onclick="window.location.href='card-sync.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="page-title">
                <i class="fas fa-redo"></i>
                Reset Kartu
            </h1>
            <div class="header-spacer"></div>
        </header>

        <!-- Warning -->
        <div class="warning-card">
            <div class="warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="warning-content">
                <h3>Perhatian!</h3>
                <p>Dengan mereset kartu, kartu lama Anda akan dinonaktifkan dan tidak bisa digunakan lagi. Anda dapat
                    mendaftarkan kartu baru setelah proses ini selesai.</p>
            </div>
        </div>

        <!-- Steps Progress -->
        <div class="steps-progress">
            <div class="progress-step active" id="progStep1">
                <div class="progress-dot"></div>
                <span>Email</span>
            </div>
            <div class="progress-line" id="progLine1"></div>
            <div class="progress-step" id="progStep2">
                <div class="progress-dot"></div>
                <span>OTP</span>
            </div>
            <div class="progress-line" id="progLine2"></div>
            <div class="progress-step" id="progStep3">
                <div class="progress-dot"></div>
                <span>Selesai</span>
            </div>
        </div>

        <!-- Step 1: Email Verification -->
        <div class="step-content active" id="step1Content">
            <div class="content-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h2>Verifikasi Email</h2>
                    <p>Masukkan email yang terdaftar pada akun Anda</p>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" placeholder="contoh@email.com" readonly>
                    </div>
                </div>
                <button class="primary-btn" onclick="sendOtp()">
                    <i class="fas fa-paper-plane"></i>
                    Kirim Kode OTP
                </button>
            </div>
        </div>

        <!-- Step 2: OTP Verification -->
        <div class="step-content" id="step2Content">
            <div class="content-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h2>Masukkan Kode OTP</h2>
                    <p>Kode 6 digit telah dikirim ke email Anda</p>
                </div>
                <div class="otp-inputs">
                    <input type="text" maxlength="1" class="otp-input" data-index="0">
                    <input type="text" maxlength="1" class="otp-input" data-index="1">
                    <input type="text" maxlength="1" class="otp-input" data-index="2">
                    <input type="text" maxlength="1" class="otp-input" data-index="3">
                    <input type="text" maxlength="1" class="otp-input" data-index="4">
                    <input type="text" maxlength="1" class="otp-input" data-index="5">
                </div>
                <div class="resend-timer">
                    <span id="timerText">Kirim ulang dalam <span id="countdown">60</span> detik</span>
                    <button class="resend-btn" id="resendBtn" onclick="sendOtp()" disabled>Kirim Ulang</button>
                </div>
                <button class="primary-btn" onclick="verifyOtp()">
                    <i class="fas fa-check"></i>
                    Verifikasi
                </button>
            </div>
        </div>

        <!-- Step 3: Success -->
        <div class="step-content" id="step3Content">
            <div class="content-card success">
                <div class="success-animation">
                    <div class="checkmark">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
                <h2>Kartu Berhasil Direset!</h2>
                <p>Kartu lama Anda sudah dinonaktifkan. Anda sekarang dapat mendaftarkan kartu baru.</p>
                <div class="action-buttons">
                    <button class="primary-btn" onclick="window.location.href='card-sync.html'">
                        <i class="fas fa-id-card"></i>
                        Daftarkan Kartu Baru
                    </button>
                    <button class="secondary-btn" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-home"></i>
                        Kembali ke Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Check auth and load email
        document.addEventListener('DOMContentLoaded', function () {
            const sessionUser = sessionStorage.getItem('user');
            const localUser = localStorage.getItem('user');
            const user = sessionUser ? JSON.parse(sessionUser) : (localUser ? JSON.parse(localUser) : null);

            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('email').value = user.email || '';
        });

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // Send OTP
        let countdownInterval;
        async function sendOtp() {
            const email = document.getElementById('email').value;

            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Kode OTP telah dikirim ke email Anda', 'success');
                    goToStep(2);
                    startCountdown();
                } else {
                    showToast(data.message || 'Gagal mengirim OTP', 'error');
                }
            } catch (error) {
                // Demo mode
                showToast('Kode OTP telah dikirim (demo)', 'success');
                goToStep(2);
                startCountdown();
            }
        }

        // Countdown timer
        function startCountdown() {
            let seconds = 60;
            const countdownEl = document.getElementById('countdown');
            const timerText = document.getElementById('timerText');
            const resendBtn = document.getElementById('resendBtn');

            timerText.style.display = 'block';
            resendBtn.style.display = 'none';
            resendBtn.disabled = true;

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;

                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    timerText.style.display = 'none';
                    resendBtn.style.display = 'inline-block';
                    resendBtn.disabled = false;
                }
            }, 1000);
        }

        // OTP input handling
        document.querySelectorAll('.otp-input').forEach((input, index) => {
            input.addEventListener('input', function () {
                if (this.value.length === 1 && index < 5) {
                    document.querySelectorAll('.otp-input')[index + 1].focus();
                }
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    document.querySelectorAll('.otp-input')[index - 1].focus();
                }
            });
        });

        // Verify OTP
        async function verifyOtp() {
            const email = document.getElementById('email').value;
            const inputs = document.querySelectorAll('.otp-input');
            let otp = '';
            inputs.forEach(input => otp += input.value);

            if (otp.length !== 6) {
                showToast('Masukkan 6 digit kode OTP', 'error');
                return;
            }

            try {
                const response = await fetch('/api/card/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Kartu berhasil direset!', 'success');
                    goToStep(3);
                } else {
                    showToast(data.message || 'Kode OTP salah', 'error');
                }
            } catch (error) {
                // Demo mode
                showToast('Kartu berhasil direset! (demo)', 'success');
                goToStep(3);
            }
        }

        // Go to step
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));

            // Show current step
            document.getElementById(`step${step}Content`).classList.add('active');

            // Update progress
            for (let i = 1; i <= 3; i++) {
                const progStep = document.getElementById(`progStep${i}`);
                const progLine = document.getElementById(`progLine${i}`);

                if (i < step) {
                    progStep.classList.add('completed');
                    progStep.classList.remove('active');
                    if (progLine) progLine.classList.add('completed');
                } else if (i === step) {
                    progStep.classList.add('active');
                    progStep.classList.remove('completed');
                } else {
                    progStep.classList.remove('active', 'completed');
                    if (progLine) progLine.classList.remove('completed');
                }
            }
        }
    </script>
</body>

</html>